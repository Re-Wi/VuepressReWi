---
title: s19文件结构解析
date: 2025-03-19 09:26:00
tags:
  - upgrade
categories:
  - MCU
---
嵌入式MCU的**S19文件**（Motorola S-Record格式）是一种用于存储二进制机器码的文本文件格式，广泛应用于微控制器（MCU）的固件烧录。与Intel HEX文件类似，S19文件通过ASCII字符表示二进制数据，但格式和结构有所不同。以下是S19文件的内容结构原理的详细分析：

---

### **1. S19文件的核心结构**

S19文件由多行文本组成，每行称为一条**记录（Record）**。每条记录的结构如下：

```
STCCAAAA…AADDDD…DDSS
```

- **字段说明**：

  | 字段 | 长度 | 说明 |
  |---|---|---|
  | **`S`** | 1字符 | **起始符**，固定为字母 `S`。 |
  | **`T`** | 1字符 | **记录类型**（Record Type），定义记录的作用（见下文）。 |
  | **`CC`** | 2字符（1字节） | **字节数**（Byte Count），表示后续所有字段（地址+数据+校验和）的总字节数。 |
  | **`AAAA…AA`** | 2×N字符（N字节） | **地址**（Address），数据在内存中的起始地址。地址长度由记录类型决定。 |
  | **`DDDD…DD`** | 2×M字符（M字节） | **数据**（Data），实际的二进制数据（以ASCII字符表示）。 |
  | **`SS`** | 2字符（1字节） | **校验和**（Checksum），用于验证记录完整性。 |

---

### **2. 记录类型（Record Type）**

S19文件通过`T`字段区分不同类型的记录，常见类型如下：

| 类型码 | 名称 | 说明 |
|---|---|---|
| **`S0`** | **Header Record** | 文件头记录，通常包含文件名、版本等元数据（数据部分为ASCII字符串）。 |
| **`S1`** | **Data Record (16-bit Address)** | 存储16位地址的数据记录。 |
| **`S2`** | **Data Record (24-bit Address)** | 存储24位地址的数据记录。 |
| **`S3`** | **Data Record (32-bit Address)** | 存储32位地址的数据记录。 |
| **`S5`** | **Count Record** | 可选记录，表示数据记录的数量（仅用于S1/S2/S3）。 |
| **`S7`**/**`S8`**/**`S9`** | **Termination Record** | 文件结束记录，指定程序入口地址（类型与地址长度对应）。 |

---

### **3. 地址扩展机制**

S19文件通过不同的记录类型直接支持多种地址长度：

- **S1**：16位地址（最大64KB地址空间）。
- **S2**：24位地址（最大16MB地址空间）。
- **S3**：32位地址（最大4GB地址空间）。

**示例**：

- `S30400000000...`：使用`S3`类型，地址字段为4字节（32位）。
- `S2148000...`：使用`S2`类型，地址字段为3字节（24位）。

---

### **4. 校验和计算**

校验和`SS`用于验证记录的完整性，计算方法为：

1. 将记录中`CC`、地址、数据的所有**字节值相加**。
2. 取和的**低8位**，并计算其**按位取反**（即`0xFF - sum_byte + 1`）。
3. 结果即为校验和`SS`。

**示例**：记录 `S1138000AABBCCDD00112233445566778899A5`  

- 计算 `0x13（CC） + 0x80 + 0x00（地址） + 0xAA + 0xBB + 0xCC + 0xDD + 0x00 + 0x11 + 0x22 + 0x33 + 0x44 + 0x55 + 0x66 + 0x77 + 0x88 + 0x99 = 0x6D7`  
- 取低8位 `0xD7`，校验和为 `0xFF - 0xD7 + 1 = 0x29`，但实际校验和为 `0xA5`，说明示例可能存在错误（需重新核对）。

---

### **5. S19文件示例解析**

以下是一个典型的S19文件片段：

```plaintext
S00600004844521B  // S0头记录（文件名"HDR"）
S31500000000AABBCCDD001122334455667788990033  // S3类型数据记录（32位地址0x00000000）
S70500000000FA    // S7终止记录（入口地址0x00000000）
```

- **S0记录**：  
  - 字节数 `06`（表示总字节数为6，包括地址、数据、校验和）。  
  - 地址字段 `0000`（无意义）。  
  - 数据 `484452`（ASCII "HDR"）。  
  - 校验和 `1B`。

- **S3记录**：  
  - 字节数 `15`（总字节数21，包含地址4字节+数据16字节+校验和1字节）。  
  - 地址 `00000000`（32位地址）。  
  - 数据 `AABBCCDD00112233445566778899`（16字节）。  
  - 校验和 `33`。

- **S7记录**：  
  - 终止记录，指定程序入口地址为 `00000000`（32位地址）。

---

### **6. S19文件 vs. Hex文件**

| 特性 | S19文件 | Hex文件 |
|---|---|---|
| **地址扩展** | 通过记录类型直接支持（S1/S2/S3） | 需扩展记录（如04类型）组合地址 |
| **校验和计算** | 低8位和取反+1 | 低8位和的补码（0x100 - sum） |
| **文件头** | S0记录包含ASCII信息 | 无专用头记录 |
| **终止记录** | S7/S8/S9指定入口地址 | 类型01（EOF）或05（入口地址） |
| **适用场景** | 摩托罗拉系MCU、旧式工具链 | 通用性更强，广泛用于现代MCU |

---

### **7. 工具链中的S19文件**

- **生成方式**：编译器/链接器（如GCC、IAR）通过指定输出格式生成（如`objcopy -O srec`）。  
- **烧录工具**：需支持S19格式的编程器（如P&E Micro、Lauterbach调试器）。  
- **调试用途**：通过S19文件可快速定位代码在内存中的分布。

---

### **总结**

S19文件通过简洁的文本格式和灵活的记录类型，为嵌入式MCU提供了一种可靠的数据传输方式。其核心特点包括：

1. **地址直接扩展**：通过S1/S2/S3记录支持不同地址长度，无需组合地址。  
2. **强校验机制**：校验和覆盖所有字段，确保数据完整性。  
3. **明确的终止记录**：S7/S8/S9直接定义程序入口地址。  

理解S19文件的结构原理，有助于：

- 手动解析或调试固件内容。  
- 适配不同MCU厂商的烧录工具。  
- 在无标准工具时，自定义脚本处理固件数据。
